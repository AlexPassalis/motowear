#!/bin/bash
# Restore latest production PostgreSQL backup to local development database
# Usage: ./bin/restore-prod-db

set -e

REMOTE_USER="alex"
REMOTE_HOST="167.235.27.203"
REMOTE_BACKUP_DIR="~/backups"
LOCAL_BACKUP_DIR="./backups"
SSH_KEY="~/.ssh/motowear"

# Create local backup directory
mkdir -p $LOCAL_BACKUP_DIR

# Get latest backup filename from production
echo "Fetching latest backup from production..."
LATEST_BACKUP=$(ssh -i $SSH_KEY $REMOTE_USER@$REMOTE_HOST "ls -t $REMOTE_BACKUP_DIR/motowear_*.sql.gz | head -n 1")

if [ -z "$LATEST_BACKUP" ]; then
    echo "Error: No backups found on production server"
    exit 1
fi

BACKUP_FILENAME=$(basename $LATEST_BACKUP)
echo "Latest backup: $BACKUP_FILENAME"

# Download the backup
echo "Downloading backup..."
scp -i $SSH_KEY $REMOTE_USER@$REMOTE_HOST:$LATEST_BACKUP $LOCAL_BACKUP_DIR/

if [ ! -f "$LOCAL_BACKUP_DIR/$BACKUP_FILENAME" ]; then
    echo "Error: Failed to download backup file"
    exit 1
fi

echo "âœ“ Downloaded: $LOCAL_BACKUP_DIR/$BACKUP_FILENAME"

# Find local postgres container
POSTGRES_CONTAINER=$(docker ps --filter "name=postgres" --format "{{.Names}}" | grep motowear | head -n 1)

if [ -z "$POSTGRES_CONTAINER" ]; then
    echo "Error: Local PostgreSQL container not found. Is the dev stack running?"
    echo "Run: make start"
    exit 1
fi

echo "âœ“ Found PostgreSQL container: $POSTGRES_CONTAINER"

# Warning and confirmation
echo ""
echo "âš ï¸  WARNING: This will REPLACE all data in your local development database!"
read -p "Continue? (yes/no): " CONFIRM

if [ "$CONFIRM" != "yes" ]; then
    echo "Cancelled."
    exit 0
fi

# Copy backup into container
echo "Copying backup into container..."
docker cp $LOCAL_BACKUP_DIR/$BACKUP_FILENAME $POSTGRES_CONTAINER:/tmp/restore.sql.gz

# Get database credentials
DB_NAME=$(docker exec $POSTGRES_CONTAINER cat /run/secrets/POSTGRES_DB)
DB_USER=$(docker exec $POSTGRES_CONTAINER cat /run/secrets/POSTGRES_USER)

echo "Restoring database: $DB_NAME as user: $DB_USER"

# Restore database
docker exec $POSTGRES_CONTAINER bash -c "
    set -e
    echo 'Decompressing backup...'
    gunzip -c /tmp/restore.sql.gz > /tmp/restore.sql

    echo 'Terminating active connections...'
    psql -U $DB_USER -d postgres -c \"SELECT pg_terminate_backend(pid) FROM pg_stat_activity WHERE datname = '$DB_NAME' AND pid <> pg_backend_pid();\" || true

    echo 'Dropping and recreating database...'
    dropdb -U $DB_USER --if-exists $DB_NAME || true
    createdb -U $DB_USER $DB_NAME

    echo 'Restoring data...'
    psql -U $DB_USER -d $DB_NAME < /tmp/restore.sql

    echo 'Cleaning up...'
    rm /tmp/restore.sql /tmp/restore.sql.gz
"

if [ $? -eq 0 ]; then
    echo ""
    echo "âœ“ Database restored successfully from production backup!"
    echo ""
    echo "ðŸ“ Note: You may also want to sync MinIO data (product images):"
    echo "   - Production MinIO console: ssh tunnel port 9001"
    echo "   - Local MinIO console: http://localhost:9001"
else
    echo "âŒ Error: Database restore failed"
    exit 1
fi
