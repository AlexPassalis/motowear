#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
SCRIPT_NAME="db_dump_cron"
CRON_SCRIPT="$SCRIPT_DIR/$SCRIPT_NAME"
LOG_DIR="$SCRIPT_DIR/../logs"
LOG_FILE="$LOG_DIR/db_backup_cron.log"

# Create logs directory if it doesn't exist
mkdir -p "$LOG_DIR"
echo "Logs directory: $LOG_DIR"

# Add PATH to crontab if not already present
if ! crontab -l 2>/dev/null | grep -q "^PATH="; then
    (crontab -l 2>/dev/null; echo "PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin") | crontab -
    echo "Added PATH to crontab"
fi

# Create cron job if it doesn't already exist
if ! crontab -l 2>/dev/null | grep -q "$CRON_SCRIPT"; then
    (crontab -l 2>/dev/null; echo "0 * * * * $CRON_SCRIPT >> $LOG_FILE 2>&1") | crontab -
    echo "Cron job created: runs every hour at minute 0"
    echo "Cron job will execute: $CRON_SCRIPT"
    echo "Logs will be written to: $LOG_FILE"
else
    echo "Cron job already exists for $SCRIPT_NAME"
fi

echo "Current crontab:"
crontab -l
